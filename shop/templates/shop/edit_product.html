{% extends "shop/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5 form-narrow">
  <div class="card card-form-sm p-4 shadow-sm">

    <div class="d-flex align-items-center gap-2 justify-content-center mb-3">
      <i class="bi bi-pencil-square fs-4"></i>
      <h2 class="fw-bold m-0">Editar Producto</h2>
    </div>

    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Nombre / Categoría -->
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nombre del Producto</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-tag"></i></span>
            <input type="text" name="name" class="form-control" value="{{ form.instance.name }}" required>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Categoría</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-grid"></i></span>
            <select name="category" class="form-select" required>
              <option value="" disabled>Selecciona una categoría</option>
              {% for value, label in categories %}
                <option value="{{ value }}" {% if value == form.instance.category %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- Marca -->
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Marca del Auto</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-car-front"></i></span>
            <select name="marca" id="id_marca" class="form-select" required>
              <option value="" disabled {% if not form.instance.marca %}selected{% endif %}>Selecciona una marca</option>
              {% for value, label in brands %}
                <option value="{{ value }}" {% if value == form.instance.marca %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- Descripción -->
      <div class="mt-2">
        <label class="form-label">Descripción</label>
        <textarea name="description" class="form-control" rows="3" placeholder="Detalle características, compatibilidades, etc.">{{ form.instance.description }}</textarea>
      </div>

      <!-- Precio / Stock -->
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Precio</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
            <input type="number" step="0.01" name="price" class="form-control" value="{{ form.instance.price }}" required>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Stock Disponible</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-box-seam"></i></span>
            <input type="number" name="stock" class="form-control" value="{{ form.instance.stock }}" required>
          </div>
        </div>
      </div>

      <!-- Imagen -->
      <div class="mt-2">
        <label class="form-label">Imagen del Producto</label>
        {% if form.instance.image %}
          <div class="text-center mb-2">
            <img src="{{ form.instance.image.url }}" class="img-fluid border rounded" style="max-height: 180px;">
            <p class="text-muted small mb-0">Actualmente:
              <a href="{{ form.instance.image.url }}" target="_blank">{{ form.instance.image }}</a>
            </p>
          </div>
        {% endif %}
        <input type="file" name="image" id="image" class="form-control">
        <div id="imagePreviewWrap" class="mt-2 d-none text-center">
          <img id="imagePreview" src="" alt="Vista previa" class="img-fluid border rounded" style="max-height: 180px;">
        </div>
      </div>

      <!-- Modelos compatibles -->
      <div class="mt-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <label class="form-label m-0 fw-bold">Modelos Compatibles</label>
          <div class="d-flex align-items-center gap-2">
            <input id="modelSearch" type="text" class="form-control form-control-sm" placeholder="Buscar..." style="max-width:220px">
            <button type="button" id="btnSelectAll" class="btn btn-sm btn-outline-primary">Todos</button>
            <button type="button" id="btnClearAll" class="btn btn-sm btn-outline-secondary">Limpiar</button>
            <span id="modelsCount" class="xsmall text-muted">Sel: 0 seleccionados · 0 totales</span>
          </div>
        </div>

        <!-- Guardamos los IDs ya asociados; SIN llamar a values_list en el template -->
        <div id="models-container"
             class="models-scroll"
             data-selected="{% for m in form.instance.compatible_models.all %}{% if not forloop.first %},{% endif %}{{ m.id }}{% endfor %}">
          {% for model in models %}
            <div class="form-check">
              <input class="form-check-input"
                     type="checkbox"
                     id="mdl_{{ model.id }}"
                     name="compatible_models"
                     value="{{ model.id }}"
                     {% if model in form.instance.compatible_models.all %}checked{% endif %}>
              <label class="form-check-label" for="mdl_{{ model.id }}">{{ model.name }}</label>
            </div>
          {% empty %}
            <small class="text-muted">Elegí primero la Marca del Auto.</small>
          {% endfor %}
        </div>
      </div>

      <div class="d-grid mt-4">
        <button type="submit" class="btn btn-primary-solid">
          <i class="bi bi-save me-1"></i> Actualizar Producto
        </button>
      </div>

      {% if form.errors %}
        <div class="alert alert-danger mt-3 mb-0">
          <strong>Errores en el formulario:</strong>
          <ul class="mb-0">
            {% for field, errors in form.errors.items %}
              <li>{{ field }}: {{ errors.0 }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </form>
  </div>
</div>
{% endblock %}
