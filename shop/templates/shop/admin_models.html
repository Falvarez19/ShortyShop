{% extends "shop/base.html" %}
{% load humanize %}
{% block content %}
<div class="container product-detail-page mt-5">
  <div class="row g-4 align-items-start">

    <!-- Imagen / media -->
    <div class="col-lg-6">
      <div class="pd-media p-3">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid pd-image w-100">
        {% else %}
          <img src="https://via.placeholder.com/900x650?text=Sin+imagen" alt="Sin imagen" class="img-fluid pd-image w-100">
        {% endif %}
      </div>

      {% if product.compatible_models.all %}
        <div class="small text-muted mt-3">
          <span class="fw-semibold">Modelos compatibles:</span>
          {{ product.compatible_models.all|join:", " }}
        </div>
      {% endif %}
    </div>

    <!-- Info -->
    <div class="col-lg-6">
      <h1 class="pd-title">{{ product.name }}</h1>

      <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
        <span class="meta-badge">{{ product.category }}</span>
        {% if product.marca %}
          <span class="dot"></span>
          <span class="meta-badge">{{ product.marca }}</span>
        {% endif %}
      </div>

      <!-- Precio + stock (badge grande) -->
      <div class="d-flex align-items-center gap-3 mb-3 flex-wrap">
        <span class="price-main">
          ${{ product.price|floatformat:0|intcomma:True }}
        </span>

        {% if product.stock|default:0 > 0 %}
          <span class="stock-badge {% if product.stock <= 3 %}low{% endif %}">
            Stock: {{ product.stock|intcomma }}
          </span>
          {% if product.stock <= 3 %}
            <small class="text-danger-emphasis fw-semibold">¡Quedan pocas unidades!</small>
          {% endif %}
        {% else %}
          <span class="stock-badge out">Sin stock</span>
        {% endif %}
      </div>

      {% if request.user.is_staff %}
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <a href="{% url 'edit_product' product.id %}" class="btn-action btn-edit">
          <i class="bi bi-pencil"></i> Editar producto
        </a>
        <form method="POST" action="{% url 'delete_product' product.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn-action btn-delete">
            <i class="bi bi-trash"></i> Eliminar producto
          </button>
        </form>
      </div>
      {% endif %}

      <form method="post" action="{% url 'add_to_cart' product.id %}">
        {% csrf_token %}
        <div class="row g-2 align-items-end mb-3">
          <div class="col-6 col-sm-4 col-md-3">
            <label class="form-label xsmall mb-1">Cantidad</label>
            <input
              type="number"
              name="quantity"
              min="1"
              max="{{ product.stock }}"
              value="{% if product.stock > 0 %}1{% else %}0{% endif %}"
              class="form-control qty-input"
              {% if product.stock|default:0 <= 0 %}disabled{% endif %}
            >
            {% if product.stock|default:0 > 0 %}
              <small class="text-muted xsmall">En Stock: {{ product.stock|intcomma }}</small>
            {% endif %}
          </div>
        </div>

        <button
          type="submit"
          class="btn btn-primary-solid w-100"
          {% if product.stock|default:0 <= 0 %}disabled{% endif %}
        >
          <i class="bi bi-cart-plus"></i> Agregar al carrito
        </button>
        {% if product.stock|default:0 <= 0 %}
          <div class="mt-2 small text-muted">No disponible por ahora.</div>
        {% endif %}
      </form>

      {% if product.description %}
        <hr class="my-4">
        <h6 class="fw-bold mb-2">Descripción</h6>
        <p class="mb-0">{{ product.description }}</p>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}
